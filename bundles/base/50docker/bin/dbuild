#!/usr/bin/env zsh
#
# Build the dockerfile in the current directory.  Use '-f' to ignore cache.
#

#
# Params
#
force=0
if [ "$1" = "-f" ]; then
    echo "Force: true"
    force=1
else
    echo "Force: false"
fi

#
# Some configs
#
local localip="$(/sbin/ip -o -4 addr list | grep ' docker0' | awk '{print $4}' | cut -d/ -f 1)"
echo "Local: $localip"

if [ -r "./Dockerfile" ]; then
    img="`basename $(pwd)`"

    echo ">>> Building Dockerfile for image $img <<< "
    echo

    # Figure out if we allow caching or not (-f flag)
    local cache=""
    if [ $force -ne 0 ]; then
        cache="--no-cache=true"
    fi

    set -x
    docker build --rm --force-rm ${=cache} --network=host -t "cheilman/${img}:latest" .
    ext=$?
    if [ $ext -ne 0 ]; then
        echo "!!! Build '$img' Failed! !!!"
    else
        echo ">>> Build '$img' Succeeded! <<<"
    fi

    exit $ext
else
    echo "!!! No docker file in `pwd` !!!"
    exit 1
fi
