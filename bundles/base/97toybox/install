#!/usr/bin/env zsh

#
# Aliases for toybox commands that don't exist on the system
#

moduledir="${1:-/dev/null}"
generateddir="${2:-/dev/null}"

#
# Figure out which toybox to use
#
machine="$(uname -m)"
if [ -x "${moduledir}/arch-bin/toybox-${machine}" ]; then
  carapace-redirect "${moduledir}/arch-bin/toybox-${machine}" "${moduledir}/bin/toybox"
elif [ "${machine}" = "arm64" ]; then
  # TODO: Figure out how to get mac support...
  carapace-message "brown" "Did not find toybox-${machine}..."
else
  carapace-message "brown" "Did not find toybox-${machine}..."
fi

if [ ! -x "${moduledir}/bin/toybox" ]; then
  carapace-message "red" "Failed to find appropriate architecture for toybox (${machine})..."
  exit
fi

#
# Figure out what commands we want to use
#

tb_alias_zshrc="${moduledir}/tbaliases"

cat > ${tb_alias_zshrc} <<EOF
#!zsh
#
# For commands that we like that aren't on the system, alias to our toybox install
#
# GENERATED FILE!! DO NOT EDIT
# $(date)
#

EOF

toyboxSupports() {
  local cmd="$1"

  for i in $(${moduledir}/bin/toybox); do
    if [ "$cmd" = "$i" ]; then
      return 0
    fi
  done

  return 1
}

toyboxCheckAndAlias() {
    local cmd="$1"

    # See if command exists
    command -v "$cmd" &> /dev/null
    if [ $? -eq 0 ]; then
        return
    fi

    # See if toybox supports the command
    toyboxSupports "$cmd" || return

    # Set up the alias
    echo "alias $cmd='toybox $cmd'" >> ${tb_alias_zshrc}
}

# Adds a lot of shit
for c in `toybox --list`; do
    toyboxCheckAndAlias $c
done

