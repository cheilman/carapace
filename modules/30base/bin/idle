#!/usr/bin/env zsh
#
# Idle screen
#

#
# Load goodies
#
if [ -z "$CAHHOME" ]; then
    export CAHHOME="`$HOME/.find-cahhome`"
fi

. $CAHHOME/script-init

#
# Idle
#

# If we have a sysdash program compiled for this host, use that
which sysdash &>/dev/null
if [ $? -eq 0 ]; then
    # Also load whatever sysdash environment variables we have
    if [ -r $CAHHOME/modules/sysdash/mid ]; then
        source $CAHHOME/modules/sysdash/mid
    fi

    if [ -r ~/.host/config/sysdash ]; then
        source ~/.host/config/sysdash
    fi

    # And our git repo environment variables
    if [ -r $CAHHOME/modules/git/mid ]; then
        source $CAHHOME/modules/git/mid
    fi

    sysdash
else
    # Use our old idle program

    autoload colors && colors

    source $CAHHOME/base/scripts/load
    source $CAHHOME/base/scripts/stats

    #
    # Display idle stuff without perl
    #

    host=`pretty-hostname`
    useW=`which W 2> /dev/null`
    if [ $? -ne 0 ]; then
        useW=""
    elif [ ! -x "$useW" ]; then
        useW=""
    fi

    get_stats()
    {
        echo -en "`stats`"
    }

    get_repos()
    {
        if [ -n "$useW" ]; then
            echo -en "`$useW`"
        fi
    }

    title="I:${host}"
    echo -e '\033k'$title'\033\\'
    echo -e '\033]2;'$title'\007'

    while true; do
        stats="$(get_stats)"
        repos="$(get_repos)"

        clear

        echo
        echo "$stats"
        if [ -n "$repos" ]; then
            echo
            echo "$fg[cyan]Repository Status$reset_color..."
            echo "$repos"
        fi

        sleep 10
    done
fi


