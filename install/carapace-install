#!/usr/bin/env zsh
#
# Generate and install all the Carapace files
#
set -e

#
# Prepare
#

# Try to autodetect carapace folder
export CARAPACE="${0:A:h:h}"

if [ ! -d "$CARAPACE" ]; then
    export CARAPACE="$HOME/.carapace"

    if [ ! -d "$CARAPACE" ]; then
        >&2 echo "Unable to find carapace folder!"
        exit 1
    fi
fi

export PATH="$CARAPACE/install:$PATH"
export CARAPACE_GENERATED="$CARAPACE/generated"
export CARAPACE_MODULES=""
export CARAPACE_INDENT=""

carapace-message "boldcyan" "Carapace Installation Starting..."
export CARAPACE_INDENT=" >"
carapace-message "cyan" "using source folder '$CARAPACE'"

# Create bin folder
mkdir -p "$HOME/bin/carapace" &> /dev/null || :

#
# Functions
#

#
# Install our installation and update files
#

carapace-redirect "$CARAPACE/install/carapace-install" "$HOME/bin/carapace/carapace-install"
carapace-redirect "$CARAPACE/install/carapace-update" "$HOME/bin/carapace/carapace-update"

#
# Create any necessary folders that might not exist yet.
#

carapace-message "cyan" "creating necessary folders"

mkdir -p "$HOME/.config" &> /dev/null || :
mkdir -p "$HOME/.ssh" --mode 700 &> /dev/null || :

ls -ld $HOME/.config
ls -ld $HOME/.ssh

#
# Clear out the generated folder
#

# NOTE: We only want to deleted the generated files, keep the timestamps or it may cause trouble
carapace-message "cyan" "clearing old generated files"
if [ -d "${CARAPACE_GENERATED}" -a -n "$(ls -A ${CARAPACE_GENERATED}/generated* 2> /dev/null)" ]; then
    rm -f $CARAPACE_GENERATED/generated* &> /dev/null || :
fi

#
# Start by creating the boilerplate/headers for the generated files
#

carapace-message "cyan" "setting up generated file boilerplate"
for i in crontab gitconfig profile ssh_config zshrc; do
    cp $CARAPACE/docs/templates/$i-template $CARAPACE_GENERATED/generated-$i

    echo "#" >> $CARAPACE_GENERATED/generated-$i
    echo "# Generated: $(date -u)" >> $CARAPACE_GENERATED/generated-$i
    echo "#" >> $CARAPACE_GENERATED/generated-$i
    echo >> $CARAPACE_GENERATED/generated-$i
done

( # vimrc
    cp $CARAPACE/docs/templates/vimrc-template $CARAPACE_GENERATED/generated-vimrc

    echo "\"" >> $CARAPACE_GENERATED/generated-vimrc
    echo "\" Generated: $(date -u)" >> $CARAPACE_GENERATED/generated-vimrc
    echo "\"" >> $CARAPACE_GENERATED/generated-vimrc
    echo >> $CARAPACE_GENERATED/generated-vimrc
)

#
# Run through the bundles and link their modules
#
(
    carapace-message "cyan" "evaluating bundles"
    export CARAPACE_INDENT="  ${CARAPACE_INDENT}"

    cd $CARAPACE/bundles
    for i in *; do
        if [ -d "$i" ]; then
            carapace-message "boldblue" "processing bundle $i"

            # Update bundle if it has its own repo
            (
                cd $i

                if [ -d "./.git" ]; then
                    git pull -q --recurse-submodules
                fi
            )

            carapace-install-bundle "$(readlink -f $i)" "$CARAPACE/modules" "$CARAPACE_GENERATED" || (
                carapace-message "boldred" "$i module failed!"
            )
        fi
    done

    export CARAPACE_INDENT="${CARAPACE_INDENT:2}"
)

#
# Now start checking modules
#

(
    carapace-message "cyan" "evaluating modules"
    export CARAPACE_INDENT="  ${CARAPACE_INDENT}"

    cd $CARAPACE/modules
    for i in *; do
        if [ -d "$i" ]; then
            carapace-message "boldblue" "processing module $i"

            carapace-install-module "$(readlink -f $i)" "$CARAPACE_GENERATED" || (
                carapace-message "boldred" "$i module failed!"
            )
        fi
    done

    export CARAPACE_INDENT="${CARAPACE_INDENT:2}"
)

#
# Finalize zshrc
#

# Clear module-level variables
cat >> "${CARAPACE_GENERATED}/generated-zshrc" <<EOF
#############################
# Module Inclusion Finished #
#############################

EOF

# Clear module-level variables
cat >> "${CARAPACE_GENERATED}/generated-zshrc" <<EOF

#
# Clearing module variables
#
export CARAPACE_CURRENT_MODULE=""
export CARAPACE_CURRENT_MODULE_PATH=""

EOF

#
# Link up our generated files
#

carapace-redirect "$CARAPACE_GENERATED/generated-gitconfig" "$HOME/.gitconfig"
carapace-redirect "$CARAPACE_GENERATED/generated-gitignore" "$HOME/.gitignore"
carapace-redirect "$CARAPACE_GENERATED/generated-profile" "$HOME/.profile"
carapace-redirect "$CARAPACE_GENERATED/generated-ssh_config" "$HOME/.ssh/config"
carapace-redirect "$CARAPACE_GENERATED/generated-vimrc" "$HOME/.vimrc"

# Zshrc links to the script that updates Carapace first
carapace-redirect "$CARAPACE/zshrc-update" "$HOME/.zshrc"

#
# Install crontab
#

crontab "$CARAPACE_GENERATED/generated-crontab"

#
# Should be all good!
#

export CARAPACE_INDENT="${CARAPACE_INDENT:2}"
carapace-message "boldcyan" "Carapace Installation Complete!"
